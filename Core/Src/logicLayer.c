/******************************************************************************
 *  Bestand   : logic.c
 *  Functie   : Logic laag. Krijgt opdrachten als string, bepaalt
 *              welk commando het is en roept de juiste IO-functie aan.
 *  Auteur    : Joost
 *  Versie    : 1.2
 ******************************************************************************/

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include "stm32_ub_vga_screen.h"

/* -------------------------------------------------------------------------
 * Defines
 * ------------------------------------------------------------------------- */
#define MAX_INPUT      256
#define CHAR_WIDTH     6   // breedte van één karakter in pixels
#define CHAR_HEIGHT    8   // hoogte van één karakter in pixels
#define START_X        0   // startpositie X op scherm
#define START_Y        0   // startpositie Y op scherm

/* -------------------------------------------------------------------------
 * Prototypes
 * ------------------------------------------------------------------------- */
void string_naar_vga(const char *str);
int string_ophalen(char input[]);

/* -------------------------------------------------------------------------
 *  * DOOR: ChatGPT. REDEN: tijdelijk alternatief voor UART outptut.
 * Font data 6x8 (subset: A-Z, 0-9, spatie en komma)
 * Elke byte = 1 rij, 6 bits per karakter gebruikt
 * ------------------------------------------------------------------------- */
const uint8_t font6x8[][8] = {
    // Space ' '
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // Comma ','
    {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x30},
    // Digits '0'-'9'
    {0x3E,0x63,0x73,0x7B,0x6F,0x67,0x3E,0x00}, // 0
    {0x18,0x38,0x18,0x18,0x18,0x18,0x3C,0x00}, // 1
    {0x3C,0x66,0x0C,0x18,0x30,0x66,0x7E,0x00}, // 2
    {0x3C,0x66,0x0C,0x1C,0x0C,0x66,0x3C,0x00}, // 3
    {0x0C,0x1C,0x3C,0x6C,0x7E,0x0C,0x0C,0x00}, // 4
    {0x7E,0x60,0x7C,0x06,0x06,0x66,0x3C,0x00}, // 5
    {0x1C,0x30,0x60,0x7C,0x66,0x66,0x3C,0x00}, // 6
    {0x7E,0x66,0x0C,0x18,0x18,0x18,0x18,0x00}, // 7
    {0x3C,0x66,0x66,0x3C,0x66,0x66,0x3C,0x00}, // 8
    {0x3C,0x66,0x66,0x3E,0x06,0x0C,0x38,0x00}, // 9
    // Letters 'A'-'Z' (voorbeeld subset, kan verder aangevuld)
    {0x18,0x3C,0x66,0x7E,0x66,0x66,0x66,0x00}, // A
    {0x7C,0x66,0x66,0x7C,0x66,0x66,0x7C,0x00}, // B
    {0x3C,0x66,0x60,0x60,0x60,0x66,0x3C,0x00}, // C
    {0x78,0x6C,0x66,0x66,0x66,0x6C,0x78,0x00}, // D
    {0x7E,0x60,0x60,0x7C,0x60,0x60,0x7E,0x00}, // E
    {0x7E,0x60,0x60,0x7C,0x60,0x60,0x60,0x00}, // F
    {0x3C,0x66,0x60,0x6E,0x66,0x66,0x3C,0x00}, // G
    {0x66,0x66,0x66,0x7E,0x66,0x66,0x66,0x00}, // H
    {0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00}, // I
    {0x1E,0x0C,0x0C,0x0C,0x0C,0x6C,0x38,0x00}, // J
    {0x66,0x6C,0x78,0x70,0x78,0x6C,0x66,0x00}, // K
    {0x60,0x60,0x60,0x60,0x60,0x60,0x7E,0x00}, // L
    {0x63,0x77,0x7F,0x6B,0x63,0x63,0x63,0x00}, // M
    {0x66,0x76,0x7E,0x6E,0x66,0x66,0x66,0x00}, // N
    {0x3C,0x66,0x66,0x66,0x66,0x66,0x3C,0x00}, // O
    {0x7C,0x66,0x66,0x7C,0x60,0x60,0x7E,0x00}, // P
    {0x3C,0x66,0x66,0x66,0x6E,0x3C,0x0E,0x00}, // Q
    {0x7C,0x66,0x66,0x7C,0x78,0x6C,0x66,0x00}, // R
    {0x3C,0x60,0x60,0x3C,0x06,0x06,0x7C,0x00}, // S
    {0x7E,0x5A,0x18,0x18,0x18,0x18,0x3C,0x00}, // T
    {0x66,0x66,0x66,0x66,0x66,0x66,0x3C,0x00}, // U
    {0x66,0x66,0x66,0x66,0x66,0x3C,0x18,0x00}, // V
    {0x63,0x63,0x36,0x36,0x1C,0x1C,0x08,0x00}, // W
    {0x66,0x66,0x3C,0x18,0x3C,0x66,0x66,0x00}, // X
    {0x66,0x66,0x3C,0x18,0x18,0x18,0x3C,0x00}, // Y
    {0x7E,0x06,0x0C,0x18,0x30,0x60,0x7E,0x00}  // Z
};

/* -------------------------------------------------------------------------
 * string_ophalen()
 * ------------------------------------------------------------------------- */
int string_ophalen(char input[])
{
    if (input == NULL) return -1;
    input[strcspn(input, "\n")] = '\0';

    string_naar_vga(input);

    return 0;
}

/* -------------------------------------------------------------------------
 * DOOR: ChatGPT. REDEN: tijdelijk alternatief voor UART outptut.
 * string_naar_vga()
 * Print een string op het scherm door bitmap-font te gebruiken
 * ------------------------------------------------------------------------- */
#define START_X_OFFSET 10  // 10 pixels naar rechts
#define START_Y_OFFSET 10  // 10 pixels naar beneden

void string_naar_vga(const char *str)
{
    if (str == NULL) return;

    uint16_t x_off = START_X + START_X_OFFSET;
    uint16_t y_off = START_Y + START_Y_OFFSET;

    while (*str)
    {
        char c = *str;
        uint8_t index = 0xFF;

        // Mapping naar font6x8 index
        // font6x8: 0=space, 1=comma, 2-11=digits 0-9, 12-37=letters A-Z
        if (c == ' ')               index = 0;
        else if (c == ',')          index = 1;
        else if (c >= '0' && c <= '9') index = (c - '0') + 2;      // 0=2, 1=3 ...
        else if (c >= 'A' && c <= 'Z') index = (c - 'A') + 12;     // A=12, B=13 ...
        else if (c >= 'a' && c <= 'z') index = (c - 'a') + 12;     // a=12, b=13 ...

        if (index != 0xFF)
        {
            for (uint8_t yp = 0; yp < CHAR_HEIGHT; yp++)
            {
                uint8_t row = font6x8[index][yp];
                for (uint8_t xp = 0; xp < CHAR_WIDTH; xp++)
                {
                    if (row & (1 << (CHAR_WIDTH - 1 - xp)))
                        UB_VGA_SetPixel(x_off + xp, y_off + yp, VGA_COL_WHITE);
                    else
                        UB_VGA_SetPixel(x_off + xp, y_off + yp, VGA_COL_BLACK);
                }
            }
        }

        // Volgende karakter
        x_off += CHAR_WIDTH;
        if (x_off + CHAR_WIDTH >= VGA_DISPLAY_X)
        {
            x_off = START_X + START_X_OFFSET;
            y_off += CHAR_HEIGHT;
            if (y_off + CHAR_HEIGHT >= VGA_DISPLAY_Y)
                y_off = START_Y + START_Y_OFFSET;
        }

        str++;
    }
}

